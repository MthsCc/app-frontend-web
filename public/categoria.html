<!DOCTYPE html>
<html class="dark" lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=1200, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
    <meta name="theme-color" content="#335b7e"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="apple-mobile-web-app-title" content="EchoView"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="description" content="Categoria - EchoView"/>
    <link rel="icon" type="image/svg+xml" href="logo.svg"/>
    <link rel="apple-touch-icon" href="logo.svg"/>
    <link rel="manifest" href="manifest.json"/>
    <link rel="stylesheet" href="css/mobile.css"/>
    <title>Categoria - ECHOVIEW</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="js/affiliateDisclaimer.js"></script>
    <script src="js/ui-feedback.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#335b7e",
                        "secondary": "#707d9b",
                        "tertiary": "#a7aabd",
                        "accent": "#e2e0df",
                        "background-light": "#e2e0df",
                        "background-dark": "#051422",
                        "surface": "#072f57",
                        "surface-hover": "#335b7e",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: #072f57;
            padding: 0;
            border-radius: 0.75rem;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease;
            margin-top: 20px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .close-modal {
            position: absolute;
            right: 16px;
            top: 16px;
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            z-index: 10;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .grid-item {
            transition: transform 0.3s ease;
        }
        
        .grid-item:hover {
            transform: scale(1.05);
        }
        
        .grid-item img,
        .grid-item .no-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        
        .grid-item .no-poster {
            background: linear-gradient(135deg, #335b7e 0%, #072f57 50%, #051422 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .carousel-container {
            position: relative;
            overflow: hidden;
        }
        
        .carousel-wrapper {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            padding: 0 50px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .carousel-wrapper::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .carousel-item {
            flex-shrink: 0;
            width: 8rem;
        }
        
        .carousel-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }
        
        .carousel-arrow:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-50%) scale(1.1);
        }
        
        .carousel-arrow.left {
            left: 0;
        }
        
        .carousel-arrow.right {
            right: 0;
        }
        
        .carousel-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
    <div class="layout-container flex h-full grow flex-col">
        <!-- Header -->
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-white/10 px-4 md:px-10 py-3 sticky top-0 z-50 bg-background-dark/80 backdrop-blur-sm">
            <div class="flex items-center gap-3 text-white">
            <img src="logo.svg" alt="EchoView Logo" class="w-8 h-8 object-contain cursor-pointer brand-logo" onclick="window.location.href='catalogo.html'"/>
                <h2 class="text-white text-xl font-bold leading-tight tracking-[-0.015em] font-display cursor-pointer" onclick="window.location.href='catalogo.html'">ECHOVIEW</h2>
            </div>
            <div class="flex flex-1 justify-end items-center gap-4 md:gap-8">
                <label class="hidden md:flex flex-col min-w-40 !h-10 max-w-64">
                    <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                        <div class="text-[#a7aabd] flex border-none bg-[#072f57] items-center justify-center pl-3 rounded-l-lg border-r-0">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                        <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-white focus:outline-0 focus:ring-0 border-none bg-[#072f57] focus:border-none h-full placeholder:text-[#a7aabd] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal font-display" id="searchInput" placeholder="Buscar" value=""/>
                    </div>
                </label>
                <div class="flex gap-2">
                    <button class="md:hidden flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-[#072f57] text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5">
                        <span class="material-symbols-outlined text-white text-[20px]">search</span>
                    </button>
                    <button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 bg-[#072f57] text-white gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5" onclick="window.location.href='perfil.html'">
                        <span class="material-symbols-outlined text-white text-[20px]">person</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex flex-col gap-8 px-4 sm:px-10 md:px-20 lg:px-40 py-5">
            <!-- Category Header -->
            <div class="flex items-center justify-between">
                <h1 class="text-white text-3xl md:text-4xl font-bold leading-tight tracking-[-0.015em] font-display" id="categoryTitle">Categoria</h1>
                <div class="flex gap-2">
                    <button class="flex items-center justify-center rounded-lg h-10 px-4 bg-[#072f57] text-white hover:bg-[#335b7e] transition-colors text-sm font-bold">
                        <span class="material-symbols-outlined text-[20px]">tune</span>
                    </button>
                </div>
            </div>

            <!-- Grid de Títulos -->
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="categoryGrid">
                <div class="aspect-[2/3] bg-gray-800 rounded-lg animate-pulse"></div>
                <div class="aspect-[2/3] bg-gray-800 rounded-lg animate-pulse"></div>
                <div class="aspect-[2/3] bg-gray-800 rounded-lg animate-pulse"></div>
                <div class="aspect-[2/3] bg-gray-800 rounded-lg animate-pulse"></div>
                <div class="aspect-[2/3] bg-gray-800 rounded-lg animate-pulse"></div>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-center gap-2 mt-8" id="pagination">
                <button class="flex items-center justify-center rounded-lg h-10 px-4 bg-[#283039] text-white hover:bg-[#3a4555] transition-colors text-sm font-bold" onclick="previousPage()">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <span class="text-white text-sm font-medium" id="pageInfo">Página 1</span>
                <button class="flex items-center justify-center rounded-lg h-10 px-4 bg-[#283039] text-white hover:bg-[#3a4555] transition-colors text-sm font-bold" onclick="nextPage()">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>
        </main>
    </div>
</div>

<!-- Modal -->
<div id="titleModal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">×</button>
        <div id="modalBody"></div>
    </div>
</div>

<script>
    const API_URL = 'https://app-backend-api-h67c.onrender.com';
    // Verificar token no localStorage ou sessionStorage
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    
    if (!token) {
        window.location.href = 'login.html';
    }

    let currentPage = 1;
    let categoryType = 'popular';
    let categoryName = 'Popular';
    let selectedTitle = null;

    function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        categoryType = params.get('type') || 'popular';
        categoryName = params.get('name') || 'Popular';
        document.getElementById('categoryTitle').textContent = categoryName;
    }

    async function loadCategory(page = 1) {
        try {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '<div class="col-span-full flex items-center justify-center py-12"><div class="text-white">Carregando...</div></div>';
            
            let endpoint = '';
            
            switch(categoryType) {
                case 'popular':
                    endpoint = '/api/tmdb/popular';
                    break;
                case 'movies-popular':
                    endpoint = '/api/tmdb/movies/popular';
                    break;
                case 'tv-popular':
                    endpoint = '/api/tmdb/tv/popular';
                    break;
                case 'movies-top-rated':
                    endpoint = '/api/tmdb/movies/top-rated';
                    break;
                case 'tv-top-rated':
                    endpoint = '/api/tmdb/tv/top-rated';
                    break;
                case 'movies-now-playing':
                    endpoint = '/api/tmdb/movies/now-playing';
                    break;
                case 'tv-on-the-air':
                    endpoint = '/api/tmdb/tv/on-the-air';
                    break;
                default:
                    endpoint = '/api/tmdb/popular';
            }
            
            const response = await fetch(`${API_URL}${endpoint}?page=${page}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                grid.innerHTML = '';
                
                // Filtrar apenas títulos com poster_path válido e ID válido
                const validTitles = data.results.filter(title => title.poster_path && title.id);
                
                if (validTitles.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-white text-center py-12">Nenhum título encontrado nesta categoria.</div>';
                    return;
                }
                
                validTitles.forEach(title => {
                    // poster_path pode vir como URL completa ou caminho relativo
                    const posterUrl = title.poster_path 
                        ? (title.poster_path.startsWith('http') ? title.poster_path : `https://image.tmdb.org/t/p/w300${title.poster_path}`)
                        : null;
                    
                    const item = document.createElement('div');
                    item.className = 'grid-item group cursor-pointer aspect-[2/3] overflow-hidden rounded-lg';
                    
                        item.innerHTML = `
                            <img src="${posterUrl}" alt="${title.title || title.name}" loading="lazy" />
                        `;
                    
                    item.addEventListener('click', () => {
                        openModal({
                            id: title.id,
                            title: title.title || title.name,
                            type: title.type || title.media_type || (title.name ? 'tv' : 'movie')
                        });
                    });
                    
                    grid.appendChild(item);
                });
                
                document.getElementById('pageInfo').textContent = `Página ${page}`;
                currentPage = page;
            }
        } catch (error) {
            console.error('Erro ao carregar categoria:', error);
            document.getElementById('categoryGrid').innerHTML = '<div class="col-span-full text-white text-center py-12">Erro ao carregar. Tente novamente.</div>';
        }
    }

    function nextPage() {
        loadCategory(currentPage + 1);
    }

    function previousPage() {
        if (currentPage > 1) {
            loadCategory(currentPage - 1);
        }
    }

    async function openModal(title) {
        // Fechar modal anterior se estiver aberto e limpar conteúdo
        const modal = document.getElementById('titleModal');
        const modalBody = document.getElementById('modalBody');
        
        // Limpar conteúdo anterior, especialmente iframes
        modalBody.innerHTML = '';
        
        // Se o modal estava aberto, fechar primeiro
        if (modal.classList.contains('show')) {
            modal.classList.remove('show');
            // Aguardar um pouco para a animação de fechamento
            await new Promise(resolve => setTimeout(resolve, 150));
        }
        
        selectedTitle = title;
        modalBody.innerHTML = '<div class="text-white text-center py-12">Carregando detalhes...</div>';
        modal.classList.add('show');
        
        try {
            // Garantir que o tipo está definido
            const titleType = title.type || 'movie';
            const titleId = title.id;
            
            if (!titleId) {
                console.error('ID do título não fornecido:', title);
                modalBody.innerHTML = '<div class="text-white text-center py-12">Erro: ID do título não encontrado</div>';
                return;
            }
            
            const detailsResponse = await fetch(`${API_URL}/api/titles/tmdb/${titleId}?type=${titleType}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            let titleData = {};
            if (detailsResponse.ok) {
                titleData = await detailsResponse.json();
            } else if (detailsResponse.status === 404) {
                // Título não encontrado no TMDB - usar dados básicos
                console.warn('Título não encontrado no TMDB:', titleId);
                titleData = {
                    title: title.title || 'Sem título',
                    overview: 'Informações não disponíveis',
                    voteAverage: 0,
                    releaseDate: null,
                    posterPath: null,
                    backdropPath: null,
                    trailerUrl: null
                };
            } else {
                // Outro erro - usar dados básicos
                console.warn('Erro ao buscar detalhes do TMDB:', detailsResponse.status);
                titleData = {
                    title: title.title || 'Sem título',
                    overview: 'Erro ao carregar informações',
                    voteAverage: 0,
                    releaseDate: null,
                    posterPath: null,
                    backdropPath: null,
                    trailerUrl: null
                };
            }
            
            // Buscar comentários (com tratamento de erro)
            let comments = [];
            try {
                const commentsResponse = await fetch(`${API_URL}/api/titles/${titleId}/comments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (commentsResponse.ok) {
                    const commentsData = await commentsResponse.json();
                    comments = commentsData.comments || [];
                }
            } catch (error) {
                console.warn('Erro ao buscar comentários:', error);
            }
            
            // Buscar interação do usuário (com tratamento de erro)
            let interaction = null;
            try {
                const interactionResponse = await fetch(`${API_URL}/api/titles/${titleId}/my-interaction`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (interactionResponse.ok) {
                    const interactionData = await interactionResponse.json();
                    interaction = interactionData.interaction || null;
                }
            } catch (error) {
                console.warn('Erro ao buscar interação:', error);
            }
            
            // Buscar títulos similares (com tratamento de erro)
            let similarTitles = { results: [] };
            try {
                const similarResponse = await fetch(`${API_URL}/api/titles/similar/${titleId}?type=${titleType}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
                if (similarResponse.ok) {
                    similarTitles = await similarResponse.json();
                } else {
                    console.warn('Erro ao buscar títulos similares:', similarResponse.status);
                }
            } catch (error) {
                console.warn('Erro ao buscar títulos similares:', error);
            }
            
            // Processar nota - voteAverage de 0-5
            const rating = titleData.voteAverage !== undefined && titleData.voteAverage !== null && titleData.voteAverage > 0
                ? titleData.voteAverage.toFixed(1) 
                : '';
            
            // Processar trailer
            let trailerUrl = titleData.trailerUrl || null;
            const trailerSite = titleData.trailerSite || 'YouTube';
            
            // Obter imagem de fallback (backdrop primeiro, depois poster)
            const backdropPath = titleData.backdropPath || null;
            const posterPath = titleData.posterPath || null;
            const fallbackImage = backdropPath || posterPath;
            
            // Não adicionar autoplay por padrão - deixar o usuário clicar para assistir
            const trailerHtml = trailerUrl ? `
                <div class="mb-6">
                    <h3 class="text-white text-lg font-bold mb-3">Trailer</h3>
                    <div class="relative w-full aspect-video rounded-lg overflow-hidden bg-black">
                        <iframe src="${trailerUrl}" 
                                class="w-full h-full" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                        </iframe>
                    </div>
                </div>
            ` : `
                <div class="mb-6">
                    <h3 class="text-white text-lg font-bold mb-3">Imagem</h3>
                    <div class="relative w-full aspect-video rounded-lg overflow-hidden bg-gray-800">
                        ${fallbackImage ? `
                            <img src="${fallbackImage}" 
                                 alt="${title.title || titleData.title || titleData.name || 'Imagem do título'}" 
                                 class="w-full h-full object-cover" 
                                 onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center\\'><span class=\\'text-gray-400\\'>Imagem não disponível</span></div>'">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center">
                                <span class="text-gray-400">Trailer e imagem não disponíveis</span>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // Processar títulos similares - criar carrossel infinito
            const similarResults = similarTitles.results || [];
            const carouselId = `carousel-${titleId}`;
            const similarTitlesHtml = similarResults.length > 0 ? `
                <div class="mb-6">
                    <h3 class="text-white text-lg font-bold mb-3">Títulos Similares</h3>
                    <div class="carousel-container relative" id="${carouselId}">
                        <button class="carousel-arrow left" onclick="scrollCarousel('${carouselId}', -1)">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <div class="carousel-wrapper" id="${carouselId}-wrapper">
                            ${Array(2).fill(similarResults).flat().map((similar) => {
                                const similarTitle = similar.title || similar.name || 'Sem título';
                                const similarType = similar.type || similar.media_type || titleType || 'movie';
                                const similarPosterPath = similar.poster_path || '';
                                const similarRating = similar.vote_average !== undefined && similar.vote_average !== null && similar.vote_average > 0
                                    ? similar.vote_average.toFixed(1) 
                                    : '';
                                
                                const posterUrl = similarPosterPath 
                                    ? (similarPosterPath.startsWith('http') ? similarPosterPath : `https://image.tmdb.org/t/p/w300${similarPosterPath}`)
                                    : null;
                                
                                return `
                                    <div class="carousel-item cursor-pointer group" onclick="openModal({id: ${similar.id}, title: '${similarTitle.replace(/'/g, "\\'")}', type: '${similarType}'})">
                                        <div class="aspect-[2/3] rounded-lg overflow-hidden bg-gray-800 relative">
                                            ${posterUrl ? `
                                                <img src="${posterUrl}" alt="${similarTitle}" class="w-full h-full object-cover group-hover:scale-105 transition-transform" loading="lazy" />
                                            ` : `
                                                <div class="w-full h-full flex items-center justify-center text-gray-400 text-xs">Sem pôster</div>
                                            `}
                                        </div>
                                        <p class="text-white text-sm font-medium mt-2 truncate">${similarTitle}</p>
                                        ${similarRating ? `<p class="text-[#a7aabd] text-xs">⭐ ${similarRating}/5</p>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button class="carousel-arrow right" onclick="scrollCarousel('${carouselId}', 1)">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                        </div>
                </div>
            ` : '';
            
            modalBody.innerHTML = `
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            ${trailerHtml}
                            ${similarTitlesHtml}
                    </div>
                    <div class="flex flex-col gap-4">
                            <div>
                                <h2 class="text-white text-2xl font-bold mb-2">${title.title || titleData.title || titleData.name}</h2>
                                <div class="flex items-center gap-4 flex-wrap mb-4">
                                    ${titleData.releaseDate ? `<span class="text-[#a7aabd] text-sm">${new Date(titleData.releaseDate).getFullYear()}</span>` : ''}
                                    ${rating ? `
                                <div class="flex items-center gap-1 text-yellow-400">
                                    <span class="material-symbols-outlined text-base" style="font-variation-settings: 'FILL' 1;">star</span>
                                            <span class="text-sm font-bold">${rating}/5</span>
                                        </div>
                                    ` : ''}
                                    <span class="px-2 py-1 rounded text-xs font-bold ${titleType === 'tv' ? 'bg-blue-900/50 text-blue-300' : 'bg-red-900/50 text-red-300'}">
                                        ${titleType === 'tv' ? 'Série' : 'Filme'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-700 pt-4">
                                <h3 class="text-white font-bold mb-3">Sinopse</h3>
                                <p class="text-[#e2e0df] text-sm leading-relaxed">${titleData.overview || 'Sinopse não disponível'}</p>
                        </div>
                            
                            <div class="border-t border-gray-700 pt-4">
                                <h3 class="text-white font-bold mb-3">Status</h3>
                                <div class="flex flex-col gap-2">
                                    <label class="flex items-center gap-2 cursor-pointer text-white hover:bg-gray-800 p-2 rounded">
                                        <input type="radio" name="status" value="want_to_watch" class="w-4 h-4" ${interaction && interaction.status === 'want_to_watch' ? 'checked' : ''} onchange="updateStatus('want_to_watch')" />
                                        <span>Quero Assistir</span>
                                </label>
                                    <label class="flex items-center gap-2 cursor-pointer text-white hover:bg-gray-800 p-2 rounded">
                                        <input type="radio" name="status" value="watched" class="w-4 h-4" ${interaction && interaction.status === 'watched' ? 'checked' : ''} onchange="updateStatus('watched')" />
                                        <span>Já Assisti</span>
                                </label>
                                    <label class="flex items-center gap-2 cursor-pointer text-white hover:bg-gray-800 p-2 rounded">
                                        <input type="radio" name="status" value="dropped" class="w-4 h-4" ${interaction && interaction.status === 'dropped' ? 'checked' : ''} onchange="updateStatus('dropped')" />
                                        <span>Abandonado</span>
                                </label>
                            </div>
                        </div>
                            
                            <div class="border-t border-gray-700 pt-4">
                                <h3 class="text-white font-bold mb-3">Comentários (${comments.length})</h3>
                                <div class="space-y-3 max-h-60 overflow-y-auto mb-3">
                                    ${comments.length > 0 ? comments.map(comment => {
                                        const commentText = comment.comment || comment.text || '';
                                        const userName = comment.userName || 'Usuário';
                                        const createdAt = comment.createdAt ? new Date(comment.createdAt).toLocaleDateString('pt-BR') : '';
                                        return `
                                            <div class="bg-gray-800/50 p-3 rounded">
                                                <p class="text-white text-sm font-bold">${userName}</p>
                                                <p class="text-[#a7aabd] text-xs mb-1">${createdAt}</p>
                                                <p class="text-[#e2e0df] text-sm">${commentText}</p>
                            </div>
                                        `;
                                    }).join('') : '<p class="text-gray-400 text-sm">Nenhum comentário ainda</p>'}
                                            </div>
                                <textarea class="w-full bg-gray-800 text-white text-sm rounded p-2 resize-none" id="commentInput" placeholder="Deixe seu comentário..." rows="2"></textarea>
                                <button class="w-full mt-2 bg-primary text-white font-bold py-2 rounded hover:bg-blue-700 transition" onclick="submitComment()">Enviar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Inicializar carrossel infinito após inserir no DOM
            if (similarResults.length > 0) {
                setTimeout(() => {
                    initInfiniteCarousel(carouselId);
                }, 200);
            }
        } catch (error) {
            console.error('Erro ao carregar detalhes:', error);
            modalBody.innerHTML = `
                <div class="text-white text-center py-12">
                    <p class="text-lg font-bold mb-2">Erro ao carregar detalhes</p>
                    <p class="text-sm text-gray-400">${error.message || 'Erro desconhecido'}</p>
                    <button onclick="closeModal()" class="mt-4 px-4 py-2 bg-primary text-white rounded hover:bg-blue-700 transition">Fechar</button>
                </div>
            `;
        }
    }

    async function updateStatus(status) {
        if (!selectedTitle) return;
        
        try {
            const titleType = selectedTitle.type || 'movie';
            const titleId = selectedTitle.id;
            
            // Buscar dados do título do TMDB
            const detailsResponse = await fetch(`${API_URL}/api/titles/tmdb/${titleId}?type=${titleType}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            let titleData = {};
            if (detailsResponse.ok) {
                titleData = await detailsResponse.json();
            }
            
            // Salvar status no banco
            const response = await fetch(`${API_URL}/api/titles/interaction`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    tmdbId: titleId,
                    type: titleType,
                    title: titleData.title || selectedTitle.title || 'Título',
                    releaseDate: titleData.releaseDate || null,
                    overview: titleData.overview || null,
                    posterPath: titleData.posterPath || null,
                    voteAverage: titleData.voteAverage || 0,
                    genres: titleData.genres || [],
                    status: status
                })
            });
            
            if (response.ok) {
                // Recarregar o modal para atualizar o status marcado
                await openModal(selectedTitle);
            } else {
                const errorData = await response.json();
                alert('Erro ao salvar status: ' + (errorData.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro ao atualizar status:', error);
            alert('Erro ao salvar status. Tente novamente.');
        }
    }

    async function submitComment() {
        if (!selectedTitle) return;
        
        const commentInput = document.getElementById('commentInput');
        const comment = commentInput.value.trim();
        
        if (!comment) {
            alert('Por favor, escreva um comentário');
            return;
        }
        
        try {
            // Primeiro, buscar os dados do título do TMDB e a interação atual
            const titleType = selectedTitle.type || 'movie';
            const titleId = selectedTitle.id;
            
            const [detailsResponse, interactionResponse] = await Promise.all([
                fetch(`${API_URL}/api/titles/tmdb/${titleId}?type=${titleType}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }),
                fetch(`${API_URL}/api/titles/${titleId}/my-interaction`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
            ]);
            
            let titleData = {};
            if (detailsResponse.ok) {
                titleData = await detailsResponse.json();
            }
            
            // Obter status atual da interação, ou usar 'watched' como padrão
            let currentStatus = 'watched';
            if (interactionResponse.ok) {
                const interactionData = await interactionResponse.json();
                if (interactionData.interaction && interactionData.interaction.status) {
                    currentStatus = interactionData.interaction.status;
                }
            }
            
            // Enviar interação com comentário (mantém o status atual)
            const response = await fetch(`${API_URL}/api/titles/interaction`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    tmdbId: titleId,
                    type: titleType,
                    title: titleData.title || selectedTitle.title || 'Título',
                    releaseDate: titleData.releaseDate || null,
                    overview: titleData.overview || null,
                    posterPath: titleData.posterPath || null,
                    voteAverage: titleData.voteAverage || 0,
                    genres: titleData.genres || [],
                    status: currentStatus, // Manter o status atual
                    comment: comment
                })
            });
            
            if (response.ok) {
                commentInput.value = '';
                // Recarregar o modal para mostrar o novo comentário
                await openModal(selectedTitle);
            } else {
                const errorData = await response.json();
                alert('Erro ao salvar comentário: ' + (errorData.error || 'Erro desconhecido'));
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('Erro ao salvar comentário. Tente novamente.');
        }
    }

    function closeModal() {
        const modal = document.getElementById('titleModal');
        const modalBody = document.getElementById('modalBody');
        
        // Limpar o conteúdo do modal, especialmente iframes de vídeo
        modalBody.innerHTML = '';
        
        // Remover a classe show para fechar o modal
        modal.classList.remove('show');
        selectedTitle = null;
    }

    // Função para scroll do carrossel infinito (parado - só move ao clicar)
    function scrollCarousel(carouselId, direction) {
        const wrapper = document.getElementById(`${carouselId}-wrapper`);
        if (!wrapper) return;
        
        const itemWidth = 128 + 16; // 8rem (128px) + gap (16px)
        const scrollAmount = itemWidth * 3; // Scroll 3 itens por vez
        const currentScroll = wrapper.scrollLeft || 0;
        
        let newScroll = currentScroll + (scrollAmount * direction);
        
        // O evento de scroll cuida do reset infinito, então apenas fazer o scroll normal
        wrapper.scrollTo({
            left: newScroll,
            behavior: 'smooth'
        });
    }
    
    // Inicializar carrossel infinito após renderizar
    function initInfiniteCarousel(carouselId) {
        const wrapper = document.getElementById(`${carouselId}-wrapper`);
        if (!wrapper) return;
        
        const itemWidth = 128 + 16;
        const itemsPerSet = Math.floor(wrapper.scrollWidth / 2 / itemWidth);
        const setWidth = itemWidth * itemsPerSet;
        
        // Evento de scroll para reset infinito imperceptível
        let isScrolling = false;
        wrapper.addEventListener('scroll', () => {
            if (isScrolling) return; // Evitar loop
            
            const scrollLeft = wrapper.scrollLeft;
            
            // Se chegou perto do final da segunda cópia, resetar para posição equivalente na primeira
            if (scrollLeft >= setWidth * 1.8) { // 80% da segunda cópia
                isScrolling = true;
                const excess = scrollLeft - setWidth;
                wrapper.scrollLeft = excess;
                setTimeout(() => {
                    isScrolling = false;
                }, 50);
            }
            // Se chegou perto do início, ir para posição equivalente no final da primeira cópia
            else if (scrollLeft <= 50) {
                isScrolling = true;
                wrapper.scrollLeft = setWidth + scrollLeft;
                setTimeout(() => {
                    isScrolling = false;
                }, 50);
            }
        });
    }

    window.addEventListener('click', (event) => {
        const modal = document.getElementById('titleModal');
        if (event.target === modal) {
            closeModal();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        getUrlParams();
        loadCategory(1);
    });
</script>
</body>
</html>
